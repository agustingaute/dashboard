const BA = { lat: -34.6037, lon: -58.3816, name: 'Buenos Aires' };

const WMO = {
  0: 'Despejado',  1: 'Despejado',            2: 'Parcialmente nublado',
  3: 'Nublado',   45: 'Niebla',              48: 'Niebla',
  51: 'Llovizna', 53: 'Llovizna',            55: 'Llovizna',
  61: 'Lluvia',   63: 'Lluvia',              65: 'Lluvia fuerte',
  71: 'Nieve',    80: 'Chubascos',           95: 'Tormenta',
};

// Iconos de Bas Milius / Meteocons (MIT License)
// IDs namespaciados por icono para evitar colisiones en el DOM
const ICONS = {
  sun: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="sun-a" x1="150" x2="234" y1="119.2" y2="264.8" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fbbf24"/><stop offset=".5" stop-color="#fbbf24"/><stop offset="1" stop-color="#f59e0b"/></linearGradient><symbol id="sun-b" viewBox="0 0 384 384"><circle cx="192" cy="192" r="84" fill="url(#sun-a)" stroke="#f8af18" stroke-miterlimit="10" stroke-width="6"/><path fill="none" stroke="#fbbf24" stroke-linecap="round" stroke-miterlimit="10" stroke-width="24" d="M192 61.7V12m0 360v-49.7m92.2-222.5 35-35M64.8 319.2l35.1-35.1m0-184.4-35-35m254.5 254.5-35.1-35.1M61.7 192H12m360 0h-49.7"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="rotate" values="0 192 192; 45 192 192"/></path></symbol></defs><use xlink:href="#sun-b" width="384" height="384" transform="translate(64 64)"/></svg>`,

  partcloud: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><symbol id="pc-c" viewBox="0 0 196 196"><circle cx="98" cy="98" r="40" fill="url(#pc-a)" stroke="#f8af18" stroke-miterlimit="10" stroke-width="4"/><path fill="none" stroke="#fbbf24" stroke-linecap="round" stroke-miterlimit="10" stroke-width="12" d="M98 31.4V6m0 184v-25.4M145.1 51l18-17.9M33 163l18-17.9M51 51 33 33m130.1 130.1-18-18M6 98h25.4M190 98h-25.4"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="rotate" values="0 98 98; 45 98 98"/></path></symbol><symbol id="pc-d" viewBox="0 0 350 222"><path fill="url(#pc-b)" stroke="#e6effc" stroke-miterlimit="10" stroke-width="6" d="m291 107-2.5.1A83.9 83.9 0 00135.6 43 56 56 0 0051 91a56.6 56.6 0 00.8 9A60 60 0 0063 219l4-.2v.2h224a56 56 0 000-112Z"/></symbol><symbol id="pc-e" viewBox="0 0 363 258"><use xlink:href="#pc-c" width="196" height="196"/><use xlink:href="#pc-d" width="350" height="222" transform="translate(13 36)"/></symbol><linearGradient id="pc-b" x1="99.5" x2="232.6" y1="30.7" y2="261.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f3f7fe"/><stop offset=".5" stop-color="#f3f7fe"/><stop offset="1" stop-color="#deeafb"/></linearGradient><linearGradient id="pc-a" x1="78" x2="118" y1="63.4" y2="132.7" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fbbf24"/><stop offset=".5" stop-color="#fbbf24"/><stop offset="1" stop-color="#f59e0b"/></linearGradient></defs><use xlink:href="#pc-e" width="363" height="258" transform="translate(68 109)"/></svg>`,

  cloud: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="cl-a" x1="99.5" x2="232.6" y1="30.7" y2="261.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f3f7fe"/><stop offset=".5" stop-color="#f3f7fe"/><stop offset="1" stop-color="#deeafb"/></linearGradient><symbol id="cl-b" viewBox="0 0 350 222"><path fill="url(#cl-a)" stroke="#e6effc" stroke-miterlimit="10" stroke-width="6" d="m291 107-2.5.1A83.9 83.9 0 00135.6 43 56 56 0 0051 91a56.6 56.6 0 00.8 9A60 60 0 0063 219l4-.2v.2h224a56 56 0 000-112Z"/></symbol></defs><use xlink:href="#cl-b" width="350" height="222" transform="translate(81 145)"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="translate" values="-18 0; 18 0; -18 0"/></use></svg>`,

  rain: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="rn-b" x1="99.5" x2="232.6" y1="30.7" y2="261.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f3f7fe"/><stop offset=".5" stop-color="#f3f7fe"/><stop offset="1" stop-color="#deeafb"/></linearGradient><linearGradient id="rn-a" x1="1381.3" x2="1399.5" y1="-1144.7" y2="-1097.4" gradientTransform="rotate(-9 8002.567 8233.063)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0b65ed"/><stop offset=".5" stop-color="#0a5ad4"/><stop offset="1" stop-color="#0950bc"/></linearGradient><linearGradient xlink:href="#rn-a" id="rn-e" x1="1436.7" x2="1454.9" y1="-1137" y2="-1089.7" gradientTransform="rotate(-9 8009.537 8233.037)"/><linearGradient xlink:href="#rn-a" id="rn-h" x1="1492.1" x2="1510.3" y1="-1129.3" y2="-1082.1" gradientTransform="rotate(-9 8016.566 8233.078)"/><symbol id="rn-k" viewBox="0 0 350 222"><path fill="url(#rn-b)" stroke="#e6effc" stroke-miterlimit="10" stroke-width="6" d="m291 107-2.5.1A83.9 83.9 0 00135.6 43 56 56 0 0051 91a56.6 56.6 0 00.8 9A60 60 0 0063 219l4-.2v.2h224a56 56 0 000-112Z"/></symbol><symbol id="rn-l" overflow="visible" viewBox="0 0 129 57"><path fill="url(#rn-a)" stroke="#0a5ad4" stroke-miterlimit="10" d="M8.5 56.5a8 8 0 01-8-8v-40a8 8 0 0116 0v40a8 8 0 01-8 8Z" opacity="0"><animateTransform id="rn-c" additive="sum" attributeName="transform" begin="0s; rn-c.end+.33s" dur=".67s" type="translate" values="0 -60; 0 60"/><animate id="rn-d" attributeName="opacity" begin="0s; rn-d.end+.33s" dur=".67s" keyTimes="0; .25; 1" values="0; 1; 0"/></path><path fill="url(#rn-e)" stroke="#0a5ad4" stroke-miterlimit="10" d="M64.5 56.5a8 8 0 01-8-8v-40a8 8 0 0116 0v40a8 8 0 01-8 8Z" opacity="0"><animateTransform id="rn-f" additive="sum" attributeName="transform" begin=".33s; rn-f.end+.33s" dur=".67s" type="translate" values="0 -60; 0 60"/><animate id="rn-g" attributeName="opacity" begin=".33s; rn-g.end+.33s" dur=".67s" keyTimes="0; .25; 1" values="0; 1; 0"/></path><path fill="url(#rn-h)" stroke="#0a5ad4" stroke-miterlimit="10" d="M120.5 56.5a8 8 0 01-8-8v-40a8 8 0 0116 0v40a8 8 0 01-8 8Z" opacity="0"><animateTransform id="rn-i" additive="sum" attributeName="transform" begin="-.33s; rn-i.end+.33s" dur=".67s" type="translate" values="0 -60; 0 60"/><animate id="rn-j" attributeName="opacity" begin="-.33s; rn-j.end+.33s" dur=".67s" keyTimes="0; .25; 1" values="0; 1; 0"/></path></symbol></defs><use xlink:href="#rn-k" width="350" height="222" transform="translate(81 145)"/><use xlink:href="#rn-l" width="129" height="57" transform="translate(191.5 343.5)"/></svg>`,

  drizzle: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="dz-b" x1="99.5" x2="232.6" y1="30.7" y2="261.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f3f7fe"/><stop offset=".5" stop-color="#f3f7fe"/><stop offset="1" stop-color="#deeafb"/></linearGradient><linearGradient id="dz-a" x1="1314.8" x2="1324.2" y1="-739.9" y2="-715.3" gradientTransform="rotate(-9 7682.04 6929.539)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0b65ed"/><stop offset=".5" stop-color="#0a5ad4"/><stop offset="1" stop-color="#0950bc"/></linearGradient><linearGradient xlink:href="#dz-a" id="dz-f" x1="1370.1" x2="1379.5" y1="-731.1" y2="-706.5"/><linearGradient xlink:href="#dz-a" id="dz-g" x1="1425.4" x2="1434.9" y1="-722.4" y2="-697.8"/><symbol id="dz-c" viewBox="0 0 350 222"><path fill="url(#dz-b)" stroke="#e6effc" stroke-miterlimit="10" stroke-width="6" d="m291 107-2.5.1A83.9 83.9 0 00135.6 43 56 56 0 0051 91a56.6 56.6 0 00.8 9A60 60 0 0063 219l4-.2v.2h224a56 56 0 000-112Z"/></symbol></defs><use xlink:href="#dz-c" width="350" height="222" transform="translate(81 145)"/><path fill="url(#dz-a)" stroke="#0a5ad4" stroke-miterlimit="10" d="M200 376a8 8 0 01-8-8v-12a8 8 0 0116 0v12a8 8 0 01-8 8Z" opacity="0"><animateTransform id="dz-d" additive="sum" attributeName="transform" begin="0s; dz-d.end+1s" dur="1s" keyTimes="0; .25; 1" type="translate" values="0 -32; 0 -32; 0 120;"/><animate id="dz-e" attributeName="opacity" begin="0s; dz-e.end+1s" dur="1s" keyTimes="0; .25; 1" values="0; 1; 0"/></path><path fill="url(#dz-f)" stroke="#0a5ad4" stroke-miterlimit="10" d="M256 376a8 8 0 01-8-8v-12a8 8 0 0116 0v12a8 8 0 01-8 8Z" opacity="0"><animateTransform id="dz-x2" additive="sum" attributeName="transform" begin="1.34s; dz-x2.end+1s" dur="1s" keyTimes="0; .25; 1" type="translate" values="0 -32; 0 -32; 0 120;"/><animate id="dz-y2" attributeName="opacity" begin="1.34s; dz-y2.end+1s" dur="1s" keyTimes="0; .25; 1" values="0; 1; 0"/></path><path fill="url(#dz-g)" stroke="#0a5ad4" stroke-miterlimit="10" d="M312 376a8 8 0 01-8-8v-12a8 8 0 0116 0v12a8 8 0 01-8 8Z" opacity="0"><animateTransform id="dz-h" additive="sum" attributeName="transform" begin=".67s; dz-h.end+1s" dur="1s" keyTimes="0; .25; 1" type="translate" values="0 -32; 0 -32; 0 120;"/><animate id="dz-i" attributeName="opacity" begin=".67s; dz-i.end+1s" dur="1s" keyTimes="0; .25; 1" values="0; 1; 0"/></path></svg>`,

  fog: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="fg-a" x1="96" x2="168" y1="-2.4" y2="122.3" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#d4d7dd"/><stop offset=".5" stop-color="#d4d7dd"/><stop offset="1" stop-color="#bec1c6"/></linearGradient><linearGradient xlink:href="#fg-a" id="fg-c" x2="168" y1="-50.4" y2="74.3"/><linearGradient id="fg-b" x1="150" x2="234" y1="119.2" y2="264.8" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fbbf24"/><stop offset=".5" stop-color="#fbbf24"/><stop offset="1" stop-color="#f59e0b"/></linearGradient><symbol id="fg-e" viewBox="0 0 384 384"><circle cx="192" cy="192" r="84" fill="url(#fg-b)" stroke="#f8af18" stroke-miterlimit="10" stroke-width="6"/><path fill="none" stroke="#fbbf24" stroke-linecap="round" stroke-miterlimit="10" stroke-width="24" d="M192 61.7V12m0 360v-49.7m92.2-222.5 35-35M64.8 319.2l35.1-35.1m0-184.4-35-35m254.5 254.5-35.1-35.1M61.7 192H12m360 0h-49.7"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="rotate" values="0 192 192; 45 192 192"/></path></symbol><symbol id="fg-f" overflow="visible" viewBox="0 0 264 72"><path fill="none" stroke="url(#fg-a)" stroke-linecap="round" stroke-miterlimit="10" stroke-width="24" d="M12 60h240"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="translate" values="-24 0; 24 0; -24 0"/></path><path fill="none" stroke="url(#fg-c)" stroke-linecap="round" stroke-miterlimit="10" stroke-width="24" d="M12 12h240"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="translate" values="24 0; -24 0; 24 0"/></path></symbol><clipPath id="fg-d"><path fill="none" d="M0 0h512v306H0z"/></clipPath></defs><g clip-path="url(#fg-d)"><use xlink:href="#fg-e" width="384" height="384" transform="translate(64 100)"/></g><use xlink:href="#fg-f" width="264" height="72" transform="translate(124 336)"/></svg>`,

  snow: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="sn-b" x1="99.5" x2="232.6" y1="30.7" y2="261.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f3f7fe"/><stop offset=".5" stop-color="#f3f7fe"/><stop offset="1" stop-color="#deeafb"/></linearGradient><linearGradient id="sn-a" x1="11.4" x2="32.8" y1="5.9" y2="43.1" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#86c3db"/><stop offset=".5" stop-color="#86c3db"/><stop offset="1" stop-color="#5eafcf"/></linearGradient><linearGradient xlink:href="#sn-a" id="sn-e" x1="67.4" x2="88.8" y1="5.9" y2="43.1"/><linearGradient xlink:href="#sn-a" id="sn-h" x1="123.4" x2="144.8" y1="5.9" y2="43.1"/><symbol id="sn-k" viewBox="0 0 350 222"><path fill="url(#sn-b)" stroke="#e6effc" stroke-miterlimit="10" stroke-width="6" d="m291 107-2.5.1A83.9 83.9 0 00135.6 43 56 56 0 0051 91a56.6 56.6 0 00.8 9A60 60 0 0063 219l4-.2v.2h224a56 56 0 000-112Z"/></symbol><symbol id="sn-l" overflow="visible" viewBox="0 0 156.2 49"><g><path fill="url(#sn-a)" stroke="#86c3db" stroke-miterlimit="10" d="m41.7 31-5.8-3.3a13.7 13.7 0 000-6.5l5.8-3.2a4 4 0 001.5-5.5 4 4 0 00-5.6-1.5l-5.8 3.3a13.6 13.6 0 00-2.6-2 13.8 13.8 0 00-3-1.3V4.5a4 4 0 00-8.1 0v6.6a14.3 14.3 0 00-5.7 3.2L6.6 11A4 4 0 001 12.5 4 4 0 002.5 18l5.8 3.3a13.7 13.7 0 000 6.5L2.5 31A4 4 0 001 36.5a4 4 0 003.5 2 4 4 0 002-.5l5.8-3.3a13.6 13.6 0 002.6 2 13.8 13.8 0 003 1.2v6.6a4 4 0 008.2 0v-6.6a14.2 14.2 0 005.6-3.2l6 3.3a4 4 0 002 .5 4 4 0 003.4-2 4 4 0 00-1.4-5.5ZM19 29.7a6 6 0 01-2.3-8.2 6.1 6.1 0 015.3-3 6.2 6.2 0 013 .8 6 6 0 012.2 8.2 6.1 6.1 0 01-8.2 2.2Z" opacity="0"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="rotate" values="0 24 24; 360 24 24"/><animate id="sn-c" attributeName="opacity" begin="0s; sn-c.end+1s" dur="2s" keyTimes="0; .17; .83; 1" values="0; 1; 1; 0"/></path><animateTransform id="sn-d" additive="sum" attributeName="transform" begin="0s; sn-d.end+1s" dur="2s" type="translate" values="0 -36; 0 92;"/></g><g><path fill="url(#sn-e)" stroke="#86c3db" stroke-miterlimit="10" d="m97.7 31-5.8-3.3a13.7 13.7 0 000-6.5l5.8-3.2a4 4 0 001.5-5.5 4 4 0 00-5.6-1.5l-5.8 3.3a13.6 13.6 0 00-2.6-2 13.8 13.8 0 00-3-1.3V4.5a4 4 0 00-8.1 0v6.6a14.3 14.3 0 00-5.7 3.2L62.6 11a4 4 0 00-5.6 1.5 4 4 0 001.5 5.5l5.8 3.3a13.7 13.7 0 000 6.5L58.5 31a4 4 0 00-1.5 5.5 4 4 0 003.5 2 4 4 0 002-.5l5.8-3.3a13.6 13.6 0 002.7 2 13.8 13.8 0 003 1.2v6.6a4 4 0 008 0v-6.6a14.2 14.2 0 005.7-3.2l6 3.3a4 4 0 002 .5 4 4 0 003.4-2 4 4 0 00-1.4-5.5ZM75 29.7a6 6 0 01-2.3-8.2 6.1 6.1 0 015.3-3 6.2 6.2 0 013 .8 6 6 0 012.2 8.2 6.1 6.1 0 01-8.2 2.2Z" opacity="0"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="rotate" values="0 80 24; 360 80 24"/><animate id="sn-f" attributeName="opacity" begin="-.83s; sn-f.end+1s" dur="2s" keyTimes="0; .17; .83; 1" values="0; 1; 1; 0"/></path><animateTransform id="sn-g" additive="sum" attributeName="transform" begin="-.83s; sn-g.end+1s" dur="2s" type="translate" values="0 -36; 0 92;"/></g><g><path fill="url(#sn-h)" stroke="#86c3db" stroke-miterlimit="10" d="m153.7 31-5.8-3.3a13.7 13.7 0 000-6.5l5.8-3.2a4 4 0 001.5-5.5 4 4 0 00-5.6-1.5l-5.8 3.3a13.6 13.6 0 00-2.6-2 13.8 13.8 0 00-3-1.3V4.5a4 4 0 00-8.1 0v6.6a14.3 14.3 0 00-5.7 3.2l-5.8-3.3a4 4 0 00-5.6 1.5 4 4 0 001.5 5.5l5.8 3.3a13.7 13.7 0 000 6.5l-5.8 3.2a4 4 0 00-1.5 5.5 4 4 0 003.5 2 4 4 0 002-.5l5.8-3.3a13.6 13.6 0 002.7 2 13.8 13.8 0 003 1.2v6.6a4 4 0 008 0v-6.6a14.2 14.2 0 005.7-3.2l5.8 3.3a4 4 0 002 .5 4 4 0 003.5-2 4 4 0 00-1.3-5.5ZM131 29.7a6 6 0 01-2.3-8.2 6.1 6.1 0 015.3-3 6.2 6.2 0 013 .8 6 6 0 012.2 8.2 6.1 6.1 0 01-8.2 2.2Z" opacity="0"><animateTransform additive="sum" attributeName="transform" dur="6s" repeatCount="indefinite" type="rotate" values="0 136 24; 360 136 24"/><animate id="sn-i" attributeName="opacity" begin=".83s; sn-i.end+1s" dur="2s" keyTimes="0; .17; .83; 1" values="0; 1; 1; 0"/></path><animateTransform id="sn-j" additive="sum" attributeName="transform" begin=".83s; sn-j.end+1s" dur="2s" type="translate" values="0 -36; 0 92;"/></g></symbol></defs><use xlink:href="#sn-k" width="350" height="222" transform="translate(81 145)"/><use xlink:href="#sn-l" width="156.2" height="49" transform="translate(177.9 337.5)"/></svg>`,

  storm: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><defs><linearGradient id="st-b" x1="99.5" x2="232.6" y1="30.7" y2="261.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f3f7fe"/><stop offset=".5" stop-color="#f3f7fe"/><stop offset="1" stop-color="#deeafb"/></linearGradient><linearGradient id="st-k" x1="8.7" x2="80.9" y1="17.1" y2="142.1" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f7b23b"/><stop offset=".5" stop-color="#f7b23b"/><stop offset="1" stop-color="#f59e0b"/></linearGradient><linearGradient id="st-a" x1="1381.3" x2="1399.5" y1="-1144.7" y2="-1097.4" gradientTransform="rotate(-9 8002.567 8233.063)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0b65ed"/><stop offset=".5" stop-color="#0a5ad4"/><stop offset="1" stop-color="#0950bc"/></linearGradient><linearGradient xlink:href="#st-a" id="st-e" x1="1436.7" x2="1454.9" y1="-1137" y2="-1089.7" gradientTransform="rotate(-9 8009.537 8233.037)"/><linearGradient xlink:href="#st-a" id="st-h" x1="1492.1" x2="1510.3" y1="-1129.3" y2="-1082.1" gradientTransform="rotate(-9 8016.566 8233.078)"/><symbol id="st-l" viewBox="0 0 350 222"><path fill="url(#st-b)" stroke="#e6effc" stroke-miterlimit="10" stroke-width="6" d="m291 107-2.5.1A83.9 83.9 0 00135.6 43 56 56 0 0051 91a56.6 56.6 0 00.8 9A60 60 0 0063 219l4-.2v.2h224a56 56 0 000-112Z"/></symbol><symbol id="st-m" overflow="visible" viewBox="0 0 129 57"><path fill="url(#st-a)" stroke="#0a5ad4" stroke-miterlimit="10" d="M8.5 56.5a8 8 0 01-8-8v-40a8 8 0 0116 0v40a8 8 0 01-8 8Z" opacity="0"><animateTransform id="st-c" additive="sum" attributeName="transform" begin="0s; st-c.end+.33s" dur=".67s" type="translate" values="0 -60; 0 60"/><animate id="st-d" attributeName="opacity" begin="0s; st-d.end+.33s" dur=".67s" keyTimes="0; .25; 1" values="0; 1; 0"/></path><path fill="url(#st-e)" stroke="#0a5ad4" stroke-miterlimit="10" d="M64.5 56.5a8 8 0 01-8-8v-40a8 8 0 0116 0v40a8 8 0 01-8 8Z" opacity="0"><animateTransform id="st-f" additive="sum" attributeName="transform" begin=".33s; st-f.end+.33s" dur=".67s" type="translate" values="0 -60; 0 60"/><animate id="st-g" attributeName="opacity" begin=".33s; st-g.end+.33s" dur=".67s" keyTimes="0; .25; 1" values="0; 1; 0"/></path><path fill="url(#st-h)" stroke="#0a5ad4" stroke-miterlimit="10" d="M120.5 56.5a8 8 0 01-8-8v-40a8 8 0 0116 0v40a8 8 0 01-8 8Z" opacity="0"><animateTransform id="st-i" additive="sum" attributeName="transform" begin="-.33s; st-i.end+.33s" dur=".67s" type="translate" values="0 -60; 0 60"/><animate id="st-j" attributeName="opacity" begin="-.33s; st-j.end+.33s" dur=".67s" keyTimes="0; .25; 1" values="0; 1; 0"/></path></symbol><symbol id="st-n" viewBox="0 0 102.7 186.8"><path fill="url(#st-k)" stroke="#f6a823" stroke-miterlimit="10" stroke-width="4" d="m34.8 2-32 96h32l-16 80 80-112h-48l32-64h-48z"><animate attributeName="opacity" begin="0s; st-c.end+.67s" dur="1.33s" keyTimes="0; .38; .5; .63; .75; .86; .94; 1" values="1; 1; 0; 1; 0; 1; 0; 1"/></path></symbol></defs><use xlink:href="#st-l" width="350" height="222" transform="translate(81 145)"/><use xlink:href="#st-m" width="129" height="57" transform="translate(191.5 343.5)"/><use xlink:href="#st-n" width="102.7" height="186.7" transform="translate(205.23 291)"/></svg>`,
};

function getIcon(code) {
  if ([0, 1].includes(code))                        return ICONS.sun;
  if (code === 2)                                   return ICONS.partcloud;
  if (code === 3)                                   return ICONS.cloud;
  if ([45, 48].includes(code))                      return ICONS.fog;
  if ([51, 53, 55].includes(code))                  return ICONS.drizzle;
  if ([61, 63, 65, 80, 81, 82].includes(code))      return ICONS.rain;
  if ([71, 73, 75].includes(code))                  return ICONS.snow;
  if ([95, 96, 99].includes(code))                  return ICONS.storm;
  return ICONS.cloud;
}

function buildUrl(lat, lon) {
  return `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&current=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m&timezone=auto`;
}

function rowHTML(label, current) {
  const temp = Math.round(current.temperature_2m);

  return `
    <div class="weather-row">
      <div class="weather-left">
        <span class="weather-place">${label}</span>
      </div>
      <div class="weather-right">
        <span class="weather-icon">${getIcon(current.weather_code)}</span>
        <span class="weather-temp">${temp}°</span>
      </div>
    </div>
  `;
}

export async function refreshWeather() {
  try {
    const res = await fetch(buildUrl(BA.lat, BA.lon));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { current } = await res.json();

    let html = `<div class="weather-grid">${rowHTML(BA.name, current)}`;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
          const { latitude: lat, longitude: lon } = pos.coords;
          const [weatherRes, geoRes] = await Promise.all([
            fetch(buildUrl(lat, lon)),
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=es`)
          ]);
          const { current: c } = await weatherRes.json();
          const geo = await geoRes.json();
          const raw = geo.city || geo.locality || 'Mi ubicación';
          const city = raw.replace(/^Partido de /i, '');
          const grid = document.querySelector('#weather-content .weather-grid');
          if (grid) grid.insertAdjacentHTML('beforeend', rowHTML(city, c));
        } catch (_) {}
      }, () => {});
    }

    html += '</div>';
    document.getElementById('weather-content').innerHTML = html;

  } catch (err) {
    document.getElementById('weather-content').innerHTML =
      `<div class="error-state"><span>Sin datos</span><span class="error-msg">${err.message}</span>
       <button class="retry-btn" onclick="window._retry('weather')">Reintentar</button></div>`;
  }
}
